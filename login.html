<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</title>
    <style>
        :root{
          --bg-light: #f4f4f9;
          --bg-dark: #0f1720;
          --text-light: #111827;
          --text-dark: #f1f5f9;
          --card-light: #ffffff;
          --card-dark: #111318;
          --accent: #0d6efd;
          --accent-2: #66a3ff;
          --muted-light: #6c757d;
          --muted-dark: #9aa4b2;
          --success: #16a34a;
          --danger: #dc2626;
          --transition-fast: 0.25s;
          --transition-med: 0.4s;
        }

        html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;}
        body{
          display:flex;align-items:center;justify-content:center;
          background:var(--bg-light);
          color:var(--text-light);
          transition: background var(--transition-med), color var(--transition-med);
          min-height:100vh;
          padding:20px;
        }
        body.dark{ background:var(--bg-dark); color:var(--text-dark); }

        .card{
          width:100%; max-width:400px;
          background:var(--card-light);
          border-radius:14px;
          padding:22px;
          box-shadow:0 10px 30px rgba(2,6,23,0.08);
          position:relative;
          transition: background var(--transition-med), box-shadow var(--transition-med);
        }
        body.dark .card{ background:var(--card-dark); box-shadow:0 6px 18px rgba(0,0,0,0.6); }

        h1{ margin:0 0 6px 0; font-size:22px; }
        p.lead{ margin:0 0 18px 0; color: #6b7280; }
        body.dark p.lead{ color: var(--muted-dark); }

        .theme-toggle{
          position:absolute; right:18px; top:18px;
          background:transparent;border:none;color:inherit;font-size:20px;
          cursor:pointer; display:flex; align-items:center; gap:10px;
          padding:8px;border-radius:10px; transition: transform .35s ease;
        }
        .theme-toggle .icon{ display:inline-block; transform-origin:center; transition: transform .45s ease; }
        .theme-toggle:active{ transform: scale(0.98); }

        .form-group{ margin-bottom:16px; }
        label{ display:block; margin-bottom:6px; font-size:14px; font-weight:500; }
        
        input[type="email"], input[type="password"]{
          width:100%; padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;
          font-size:15px; outline: none; transition: box-shadow .15s;
          box-sizing: border-box;
        }
        input:focus{ 
          box-shadow:0 6px 20px rgba(13,110,253,0.08); 
          border-color:var(--accent); 
        }

        button.btn{
          background:var(--accent); color:#fff; padding:10px 14px;border-radius:10px;border:none; cursor:pointer;
          font-weight:600; transition: transform .12s, background .2s;
          width:100%; margin-top:10px;
        }
        button.btn:hover{ transform: translateY(-2px); background:var(--accent-2); }
        button.btn:disabled { background: var(--muted-light); cursor: not-allowed; transform: none; }

        .message{
          padding:10px 12px; border-radius:10px; margin-bottom:16px;
          font-size:14px; display:none;
        }
        .message.success{ background:#dcfce7; border:1px solid rgba(16,185,129,0.18); color:#064e3b; }
        .message.error{ background:#ffe4e6; border:1px solid rgba(220,38,38,0.12); color:#6b021f; }

        .links{ text-align:center; margin-top:16px; font-size:14px; }
        .links a{ color:var(--accent); text-decoration:none; }
        .links a:hover{ text-decoration:underline; }

        footer{ margin-top:14px; font-size:13px; color: #6b7280; text-align:center; }
        body.dark footer{ color:var(--muted-dark); }
    </style>
</head>
<body>
    <div class="card">
        <button class="theme-toggle" id="themeToggle">
            <span class="icon">üåô</span>
        </button>
        
        <h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
        <p class="lead">–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</p>
        
        <div id="message" class="message"></div>
        
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="your@email.com" required>
            </div>
            
            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" name="password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" required>
            </div>
            
            <button type="submit" class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
        </form>
        
        <div class="links">
            –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="register.html">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a><br>
            <a href="#" id="forgotPassword">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
        </div>
        
        <footer>
            &copy; 2023 –í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
        </footer>
    </div>

    <script>
        // Supabase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const SUPABASE_URL = 'https://xtffyzlfykloqprchonc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0ZmZ5emxmeWtsb3FwcmNob25jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NzkyMzksImV4cCI6MjA3ODM1NTIzOX0.TRMs70z_Q8N5Qh_hTz9GVAEqgM7-OQQKIUHDP2KjgnM';

        class AuthService {
            constructor() {
                this.supabaseUrl = SUPABASE_URL;
                this.supabaseKey = SUPABASE_KEY;
            }

            // –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –º–µ—Ç–æ–¥–æ–º –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
            async hashPassword(password, salt) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password + salt);
                const hash = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hash))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
            async getUserByEmail(email) {
                try {
                    const response = await fetch(`${this.supabaseUrl}/rest/v1/users?email=eq.${encodeURIComponent(email)}&select=*`, {
                        method: 'GET',
                        headers: {
                            'apikey': this.supabaseKey,
                            'Authorization': `Bearer ${this.supabaseKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const users = await response.json();
                        return users.length > 0 ? users[0] : null;
                    }
                    return null;
                } catch (error) {
                    console.error('Error fetching user:', error);
                    return null;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
            async verifyPassword(password, storedHash, salt) {
                const hashedPassword = await this.hashPassword(password, salt);
                return hashedPassword === storedHash;
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
            async updateLastLogin(userId) {
                try {
                    await fetch(`${this.supabaseUrl}/rest/v1/users?id=eq.${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseKey,
                            'Authorization': `Bearer ${this.supabaseKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            last_login: new Date().toISOString(),
                            login_attempts: 0 // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
                        })
                    });
                } catch (error) {
                    console.error('Error updating last login:', error);
                }
            }

            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
            async incrementLoginAttempts(userId) {
                try {
                    const user = await this.getUserById(userId);
                    const newAttempts = (user.login_attempts || 0) + 1;
                    
                    await fetch(`${this.supabaseUrl}/rest/v1/users?id=eq.${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseKey,
                            'Authorization': `Bearer ${this.supabaseKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            login_attempts: newAttempts
                        })
                    });

                    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ 5 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
                    if (newAttempts >= 5) {
                        await this.lockUser(userId);
                    }
                } catch (error) {
                    console.error('Error incrementing login attempts:', error);
                }
            }

            // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            async lockUser(userId) {
                try {
                    const lockUntil = new Date();
                    lockUntil.setHours(lockUntil.getHours() + 1); // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ 1 —á–∞—Å

                    await fetch(`${this.supabaseUrl}/rest/v1/users?id=eq.${userId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': this.supabaseKey,
                            'Authorization': `Bearer ${this.supabaseKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            locked_until: lockUntil.toISOString()
                        })
                    });
                } catch (error) {
                    console.error('Error locking user:', error);
                }
            }

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
            async getUserById(userId) {
                try {
                    const response = await fetch(`${this.supabaseUrl}/rest/v1/users?id=eq.${userId}&select=*`, {
                        method: 'GET',
                        headers: {
                            'apikey': this.supabaseKey,
                            'Authorization': `Bearer ${this.supabaseKey}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const users = await response.json();
                        return users.length > 0 ? users[0] : null;
                    }
                    return null;
                } catch (error) {
                    console.error('Error fetching user by ID:', error);
                    return null;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            isUserLocked(user) {
                if (!user.locked_until) return false;
                return new Date(user.locked_until) > new Date();
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            async createSession(userId, sessionData = {}) {
                try {
                    const sessionToken = this.generateSessionToken();
                    const expiresAt = new Date();
                    expiresAt.setDate(expiresAt.getDate() + 7); // –°–µ—Å—Å–∏—è –Ω–∞ 7 –¥–Ω–µ–π

                    const session = {
                        user_id: userId,
                        session_token: sessionToken,
                        expires_at: expiresAt.toISOString(),
                        ...sessionData
                    };

                    const response = await fetch(`${this.supabaseUrl}/rest/v1/user_sessions`, {
                        method: 'POST',
                        headers: {
                            'apikey': this.supabaseKey,
                            'Authorization': `Bearer ${this.supabaseKey}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(session)
                    });

                    if (response.ok) {
                        return sessionToken;
                    }
                    return null;
                } catch (error) {
                    console.error('Error creating session:', error);
                    return null;
                }
            }

            generateSessionToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }
        }

        class LoginApp {
            constructor() {
                this.authService = new AuthService();
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initTheme();
                this.checkExistingSession();
            }

            setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    this.handleLogin(e);
                });

                document.getElementById('forgotPassword').addEventListener('click', (e) => {
                    this.handleForgotPassword(e);
                });
            }

            initTheme() {
                const themeToggle = document.getElementById('themeToggle');
                const themeIcon = themeToggle.querySelector('.icon');
                
                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark');
                    themeIcon.textContent = '‚òÄÔ∏è';
                }
                
                themeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark');
                    
                    if (document.body.classList.contains('dark')) {
                        localStorage.setItem('theme', 'dark');
                        themeIcon.textContent = '‚òÄÔ∏è';
                    } else {
                        localStorage.setItem('theme', 'light');
                        themeIcon.textContent = 'üåô';
                    }
                });
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!this.validateEmail(email)) {
                    this.showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email', 'error');
                    return;
                }

                if (!password) {
                    this.showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
                    return;
                }

                loginBtn.textContent = '–í—Ö–æ–¥...';
                loginBtn.disabled = true;

                try {
                    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const user = await this.authService.getUserByEmail(email);
                    
                    if (!user) {
                        this.showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                    if (this.authService.isUserLocked(user)) {
                        this.showMessage('–ê–∫–∫–∞—É–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    if (!user.is_active) {
                        this.showMessage('–ê–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'error');
                        return;
                    }

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
                    const isPasswordValid = await this.authService.verifyPassword(
                        password, 
                        user.password_hash, 
                        user.salt
                    );

                    if (!isPasswordValid) {
                        await this.authService.incrementLoginAttempts(user.id);
                        this.showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                        return;
                    }

                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                    await this.authService.updateLastLogin(user.id);
                    
                    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
                    const sessionToken = await this.authService.createSession(user.id, {
                        ip_address: await this.getClientIP(),
                        user_agent: navigator.userAgent
                    });

                    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
                    localStorage.setItem('user', JSON.stringify(user));
                    localStorage.setItem('session_token', sessionToken);
                    localStorage.setItem('user_id', user.id);

                    this.showMessage('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);

                } catch (error) {
                    this.showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ: ' + error.message, 'error');
                } finally {
                    loginBtn.textContent = '–í–æ–π—Ç–∏';
                    loginBtn.disabled = false;
                }
            }

            async handleForgotPassword(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                
                if (!this.validateEmail(email)) {
                    this.showMessage('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è', 'error');
                    return;
                }

                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
                this.showMessage('–§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'error');
            }

            validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';

                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }

            async getClientIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return data.ip;
                } catch (error) {
                    return 'unknown';
                }
            }

            checkExistingSession() {
                const sessionToken = localStorage.getItem('session_token');
                const userId = localStorage.getItem('user_id');
                
                if (sessionToken && userId) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏
                    this.showMessage('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            new LoginApp();
        });
    </script>
</body>
</html>
